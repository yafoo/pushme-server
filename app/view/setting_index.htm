{{extend './layout.htm'}}

{{block 'css'}}
<style>
    .layui-tab-card {
        box-shadow: none;
    }
    .layui-tab-card .layui-tab-content {
        padding: 15px;
    }
    .layui-tab-card .layui-word-aux {
        color: #333!important;
        padding-left: 10px!important;
    }
    .me-quote {
        padding-top: 8px;
        padding-bottom: 8px;
        font-size: 12px;
    }
    .me-status-pane {
        display: flex;
        gap: 10px;
    }
    .me-status-pane>div {
        flex: 1;
    }
    @media screen and (max-width: 767.99px) {
        .me-status-pane {
            display: block;
        }
    }
    #cert-content {
        padding-top: 48px;
        min-height: 200px;
        font-family: 
            "SF Mono",          /* macOS */
            "Cascadia Code",    /* Windows Terminal */
            "JetBrains Mono",   /* IDE 字体 */
            "Fira Code",        /* 编程连字 */
            "Source Code Pro",  /* Adobe 字体 */
            "Roboto Mono",      /* Google 字体 */
            "Ubuntu Mono",      /* Ubuntu */
            Consolas,
            monospace;
    }
    .me-btn-tls-create {
        position: absolute;
        left: 10px;
        top: 6px;
    }
</style>
{{/block}}

{{block 'main'}}
    <h2 style="line-height: 30px; color: #333; padding-top: 30px;">管理中心</h2></h2>
    <div class="layui-tab layui-tab-card" lay-filter="setting" style="margin-bottom: 0;">
        <ul class="layui-tab-title">
            <li class="layui-this">系统信息</li>
            <li>TLS/SSL</li>
            <li>PushKey</li>
            <li>账户密码</li>
        </ul>
        <div class="layui-tab-content">
            <!-- 系统信息 -->
            <div class="layui-tab-item layui-show">
                <form class="layui-form layui-form-pane me-status-pane" action="" method="post" lay-filter="status">
                    <div id="me-status-left">
                        <blockquote class="layui-elem-quote layui-font-red me-quote">系统信息（<span class="me-status-panel_port"></span>）</blockquote>
                        <div class="layui-form-item">
                            <label class="layui-form-label">操作系统</label>
                            <div class="layui-form-mid layui-word-aux me-status-platform"></div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">Node版本</label>
                            <div class="layui-form-mid layui-word-aux me-status-node"></div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">内存占用</label>
                            <div class="layui-form-mid layui-word-aux me-status-memory"></div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">运行时间</label>
                            <div class="layui-form-mid layui-word-aux me-status-uptime"></div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">系统重启</label>
                            <div class="layui-input-block">
                                <div class="layui-btn layui-btn-sm me-btn-system-restart" style="margin-top: 4px; margin-left: 10px; padding: 0 10px;">点击重启</div>
                            </div>
                        </div>
                    </div>

                    <div id="me-status-right">
                        <blockquote class="layui-elem-quote layui-font-red me-quote">服务信息（<span class="me-status-server_port"></span>）</blockquote>
                        <div class="layui-form-item">
                            <label class="layui-form-label">消息总数</label>
                            <div class="layui-form-mid layui-word-aux me-status-message_count"></div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">总连接数</label>
                            <div class="layui-form-mid layui-word-aux me-status-connection_count"></div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">客户端数</label>
                            <div class="layui-form-mid layui-word-aux me-status-client_count"></div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">运行时间</label>
                            <div class="layui-form-mid layui-word-aux me-status-pushme_uptime"></div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">服务状态</label>
                            <div class="layui-input-block">
                                <input type="checkbox" name="pushme_status" lay-filter="server" lay-skin="switch" lay-text="开启|关闭">
                                <div class="layui-btn layui-btn-sm me-btn-server-restart" style="margin-top: 4px; margin-left: 10px; padding: 0 10px;">点击重启</div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <!-- TLS/SSL -->
            <div class="layui-tab-item">
                <form class="layui-form layui-form-pane" action="" method="post">
                    <blockquote class="layui-elem-quote layui-font-red me-quote">提示：证书文件目录为：<span class="layui-badge-rim">./config/certs/</span>，私钥文件名为：<span class="layui-badge-rim">private.key</span>，证书文件名为：<span class="layui-badge-rim">cert.crt</span></blockquote>
                    <input type="hidden" name="form" value="tls" />
                    <div class="layui-form-item">
                        <label class="layui-form-label">服务证书</label>
                        <div class="layui-input-block">
                            <input type="radio" name="tls" value="none" title="无证书" lay-filter="tls" {{tls == 'none' ? 'checked' : ''}}>
                            <input type="radio" name="tls" value="public" title="公共证书" lay-filter="tls" {{tls == 'public' ? 'checked' : ''}}>
                            <input type="radio" name="tls" value="self" title="自签名证书" lay-filter="tls" {{tls == 'self' ? 'checked' : ''}}>
                        </div>
                    </div>
                    <div class="layui-form-item me-tls-content {{tls == 'self' ? '' : 'layui-hide'}}">
                        <label class="layui-form-label">证书内容</label>
                        <div class="layui-input-block">
                            <textarea id="cert-content" placeholder="" class="layui-textarea"></textarea>
                            <div class="layui-btn layui-btn-danger layui-btn-sm me-btn-tls-create">点击生成自签名证书</div>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">面板证书</label>
                        <div class="layui-input-block">
                            <input type="radio" name="panel_tls" value="none" title="无证书" lay-filter="panel_tls" {{panel_tls == 'none' ? 'checked' : ''}}>
                            <input type="radio" name="panel_tls" value="tls" title="共用服务证书（浏览器需导入证书才能访问）" lay-filter="panel_tls" {{panel_tls == 'tls' ? 'checked' : ''}}>
                        </div>
                    </div>

                    {{include './form_submit.htm'}}
                </form>
            </div>

            <!-- PushKey -->
            <div class="layui-tab-item">
                <form class="layui-form layui-form-pane" action="" method="post">
                    <input type="hidden" name="form" value="push_key" />
                    <div class="layui-form-item">
                        <label class="layui-form-label">push_key</label>
                        <div class="layui-input-block">
                            <input type="text" name="push_key" value="{{push_key || ''}}" placeholder="请输入push_key，多个用','隔开" autocomplete="off" class="layui-input">
                        </div>
                    </div>

                    {{include './form_submit.htm'}}
                </form>
            </div>

            <!-- 账户密码 -->
            <div class="layui-tab-item">
                <form class="layui-form layui-form-pane" action="" method="post">
                    <input type="hidden" name="form" value="user" />
                    {{include './form_user.htm'}}
                    {{include './form_password2.htm'}}
                    {{include './form_submit.htm'}}
                </form>
            </div>
        </div>
    </div>
{{/block}}

{{block 'js'}}
<script>
    layui.use(function() {
        var layer = layui.layer;
        var form = layui.form;
        var $ = layui.$;
      
        form.on('submit', function(data) {
            console.log(data.field);
            if(data.field.form == 'user') {
                if(!data.field.user || !data.field.password) {
                    layer.msg('账号密码不能为空！', {icon: 2});
                    return false;
                }
                if(data.field.password != data.field.password2) {
                    layer.msg('两次输入密码不一致！', {icon: 2});
                    return false;
                }
            }

            $.post('', data.field, function(res) {
                if(res.state) {
                    layer.msg(res.msg, {icon: 1});
                    if(~res.msg.indexOf('系统将自动重启')) {
                        setTimeout(function() {
                            if(data.field.panel_tls == 'none') {
                                location.replace(location.href.replace('https://', 'http://'));
                            } else {
                                location.replace(location.href.replace('http://', 'https://'));
                            }
                        }, 3000);
                    }
                } else {
                    layer.msg(res.msg, {icon: 2});
                }
            });
            return false;
        });

        // 服务操作
        form.on('switch(server)', function(data) {
            if(data.elem.checked === false) {
                layer.confirm('确定关闭消息服务吗？', {icon: 3, title:'提示'},
                    function(index) {
                        $.post('{{url("server/stop")}}', function(res) {
                            layer.close(index);
                            if(res.state) {
                                layer.msg(res.msg, {icon: 1});
                            } else {
                                layer.msg(res.msg, {icon: 2});
                            }
                        });
                    },
                    function(index) {
                        form.val('status', {pushme_status: true});
                        layer.close(index);
                    }
                );
            } else {
                $.post('{{url("server/start")}}', function(res) {
                    if(res.state) {
                        layer.msg(res.msg, {icon: 1});
                    } else {
                        layer.msg(res.msg, {icon: 2});
                        form.val('status', {pushme_status: false});
                    }
                });
            }
        });
        // 服务重启
        $('.me-btn-server-restart').click(function() {
            layer.confirm('确定重启消息服务吗？', {icon: 3, title:'提示'}, function(index) {
                $.post('{{url("server/restart")}}', function(res) {
                    layer.close(index);
                    if(res.state) {
                        layer.msg(res.msg, {icon: 1});
                    } else {
                        layer.msg(res.msg, {icon: 2});
                    }
                });
            });
        });
        // 系统重启
        $('.me-btn-system-restart').click(function() {
            layer.confirm('确定重启系统吗？', {icon: 3, title:'提示'}, function(index) {
                $.post('{{url("server/system_restart")}}', function(res) {
                    layer.close(index);
                    if(res.state) {
                        layer.msg(res.msg, {icon: 1});
                        setTimeout(function() {
                            if(data.field.panel_tls == 'none') {
                                location.replace(location.href.replace('https://', 'http://'));
                            } else {
                                location.replace(location.href.replace('http://', 'https://'));
                            }
                        }, 3000);
                    } else {
                        layer.msg(res.msg, {icon: 2});
                    }
                });
            });
        });

        // 证书切换
        form.on('radio(tls)', function(data){
            if(data.value == 'self') {
                $('.me-tls-content').removeClass('layui-hide');
            } else {
                $('.me-tls-content').addClass('layui-hide');
            }
        });
        // 生成证书
        $('.me-btn-tls-create').click(function() {
            layer.confirm('此操作会覆盖已存在证书，生成后服务会自动重启。', {icon: 3, title:'确定生成吗？'}, function(index) {
                layer.close(index);
                layer.prompt({
                    formType: 2,
                    value: "{{domains}}",
                    title: '请输入证书域名，多个以换行分开',
                    // area: ['400px', '350px']
                }, function(value, index, elem) {
                    $.post('{{url("server/tls_create")}}', {domains: value}, function(res) {
                        if(res.state) {
                            layer.close(index);
                            getCert();
                            layer.msg(res.msg, {icon: 1});
                            // setTimeout(function() {
                            //     location.reload();
                            // }, 3000);
                        } else {
                            layer.msg(res.msg, {icon: 2});
                        }
                    });
                });
            });
        });

        // 获取自签名证书内容
        const getCert = function() {
            $.post('{{url("server/getCert")}}', res => {
                getCert.is_init = true;
                if(!res.state) return;
                $('#cert-content').text(res.msg);
            });
        }

        // 系统状态
        element = layui.element;
        let timer_status = null;
        const get_status = function() {
            $.post('{{url("server/status")}}', function(res) {
                if(!res.state) return;
                const data = res.data;
                Object.keys(data).forEach(function(key) {
                    let value = data[key];
                    if(key == 'memory') {
                        const memoryMB = (value / 1024 / 1024).toFixed(2);
                        value = `${memoryMB}MB(${value}B)`;
                    } else if(~key.indexOf('uptime') && value > 0) {
                        value = formatUptimeDetailed(value);
                    } else if(key == 'pushme_status') {
                        form.val('status', {"pushme_status": value == 'start'});
                    }
                    $('.me-status-' + key).text(value);
                });
            });
        }
        const start_timer = function() {
            if(timer_status) return;
            get_status();
            timer_status = setInterval(function() {
                get_status();
            }, 5000);
        }
        const stop_timer = function() {
            if(timer_status) clearInterval(timer_status);
            timer_status = null;
        }

        start_timer();
        layui.element.on('tab(setting)', function(data) {
            data.index == 0 ? start_timer() : stop_timer();
            data.index == 1 && !getCert.is_init && getCert();
        });
    });

    function formatUptimeDetailed(seconds) {
        const totalSeconds = Math.floor(seconds);
        const milliseconds = Math.round((seconds - totalSeconds) * 1000);
        
        const days = Math.floor(totalSeconds / (24 * 60 * 60));
        const hours = Math.floor((totalSeconds % (24 * 60 * 60)) / (60 * 60));
        const minutes = Math.floor((totalSeconds % (60 * 60)) / 60);
        const secs = totalSeconds % 60;
        
        const parts = [];
        if (days > 0) parts.push(`${days}天`);
        if (hours > 0) parts.push(`${hours}时`);
        if (minutes > 0) parts.push(`${minutes}分`);
        if (secs > 0) parts.push(`${secs}秒`);
        if (milliseconds > 0 && parts.length <= 2) parts.push(`${milliseconds}毫秒`);
        
        return parts.length > 0 ? parts.join('') : '0秒';
    }
</script>
{{/block}}